"use strict";function discoveryTypeAutoComplete(){$(".discoveryTypeInput").autocomplete({source:discoveryTypeOptions,select:function(e,o){e.preventDefault(),$(this).val(o.item.label),$(this).data("sfid",o.item.value),$(this).attr("title",o.item.label)}})}function populateFormPicklists(e){var o;o=e?e.find(".formLookup"):$(".formLookup");var r=Object.keys(formFields2DiscoveryFields);r.forEach(function(e){var r='<option value="'+e+'">'+e+"</option>";o.append(r)})}function populateDiscoPicklists(e){var o=$(e).val(),r=formFields2DiscoveryFields[o],t=$(e).closest(".lookups"),i=t.find(".discoLookup");void 0===r?(i.find(".discoOption").remove(),t.find(".disco-tooltip").hide(),t.find("p.after-picklist").removeClass("after-picklist-moved")):r.length?(i.find(".discoOption").remove(),r.forEach(function(e){var o="<option class='discoOption' value=\""+e+'">'+e+"</option>";i.append(o)}),t.find(".disco-tooltip").hide(),t.find("p.after-picklist").removeClass("after-picklist-moved")):(i.find(".discoOption").remove(),t.find(".disco-tooltip").show(),t.find("p.after-picklist").addClass("after-picklist-moved"))}function cloneDR(e){var o=e.clone();o.find(".discoveryTypeInput").data("sfid",o.prevObject.find(".discoveryTypeInput").data("sfid")),o.find(".operator2Input").val(o.prevObject.find(".operator2Input").val()),o.find(".operator1Input").val(o.prevObject.find(".operator1Input").val()),o.find(".formLookup").val(o.prevObject.find(".formLookup").val()),o.find(".discoLookup").val(o.prevObject.find(".discoLookup").val());for(var r=0;r<o.find(".questionBox").length;r++)o.find(".questionBox").eq(r).data("picklistvalues",o.prevObject.find(".questionBox").eq(r).data("picklistvalues"));o.data("sfid",null),e.after(o),makeDiscoveryRulesDroppable(),discoveryTypeAutoComplete(),o.find(".formLookup").change(function(){var e=this;populateDiscoPicklists(e)})}function saveUpdates(){$("#fade").fadeIn(),$("#savingStatus").fadeIn(),validateAndSave(function(){saveAllDiscoveryRules(saveAllDRVs)})}function validateAndSave(e){var o=!1;$(".discoveryRuleNameInput").each(function(){0===$(this).val().trim().length?(addDiscoveryNameError($(this)),o=!0):removeDiscoveryNameError($(this))}),$(".discoveryRuleBox").each(function(){0===$(this).find(".selectedQuestions > li").length?(addMissingQuestionError($(this)),o=!0):removeMissingQuestionError($(this))}),$(".threshold1Input").each(function(){var e=parseInt($(this).val().trim(),10);isNaN(e)||0>e||e>999?(addTotal1Error($(this)),o=!0):removeTotal1Error($(this))}),$(".threshold2Input:visible").each(function(){if(""!==$(this).siblings(".operator2Input").val()){var e=parseInt($(this).val().trim(),10);isNaN(e)||0>e||e>999?(addTotal2Error($(this)),o=!0):removeTotal2Error($(this))}else removeTotal2Error($(this))}),$(".discoveryTypeInput:visible").each(function(){0===$(this).val().trim().length?(addDiscoveryTypeError($(this)),o=!0):removeDiscoveryTypeError($(this))}),$(".operator1Input").each(function(){var e=$(this).siblings(".andClause").find(".operator2Input").val();"Greater Than"==$(this).val()&&"Greater Than"==e?(addOperatorError($(this)),o=!0):"Less Than"==$(this).val()&&"Less Than"==e?(o=!0,addOperatorError($(this))):removeOperatorError($(this))}),$(".discoLookup:visible").each(function(){var e=$(this).val();if(e===nullSelect||null===e||""===e){var r=$(this).parent().find(".formLookup").val();r===nullSelect||null===r||""===r?removeDiscoLookupError($(this)):(addDiscoLookupError($(this)),o=!0)}else removeDiscoLookupError($(this))}),o===!0?(hideModal(savingModal),showModal(errorModal,fade)):($(".errorBorder").removeClass("errorBorder"),$(".errorText").remove(),"function"==typeof e&&e())}function addOperatorError(e){e.hasClass("errorBorder")||e.parent().after('<div class="errorText operatorError"><br/>Both operators cannot be of the same type. (ex. Greater Than AND Greater Than)</div>'),e.addClass("errorBorder")}function addDiscoLookupError(e){e.hasClass("errorBorder")||e.parent().after('<div class="errorText discoLookupError"><br/>Discovery Lookup must be filled in.</div>'),e.addClass("errorBorder")}function removeDiscoLookupError(e){e.parent().parent().find(".discoLookupError").remove(),e.removeClass("errorBorder")}function removeOperatorError(e){e.parent().parent().find(".operatorError").remove(),e.removeClass("errorBorder")}function addDiscoveryNameError(e){e.hasClass("errorBorder")||e.parent().after('<div class="errorText discoveryNameError"><br/>Discovery Rule name is required.</div>'),e.addClass("errorBorder")}function removeDiscoveryNameError(e){e.parent().parent().find(".discoveryNameError").remove(),e.removeClass("errorBorder")}function addDiscoveryTypeError(e){e.hasClass("errorBorder")||e.parent().parent().append('<div class="errorText discoveryTypeError"><br/>Discovery Type is required.</div>'),e.addClass("errorBorder")}function removeDiscoveryTypeError(e){e.parent().parent().find(".discoveryTypeError").remove(),e.removeClass("errorBorder")}function addTotal1Error(e){e.hasClass("errorBorder")||e.parent().after('<div class="errorText totalError total1Error"><br/>Total Must be an integer between 0-999.</div>'),e.addClass("errorBorder")}function removeTotal1Error(e){e.parent().parent().find(".total1Error").remove(),e.removeClass("errorBorder")}function addTotal2Error(e){e.hasClass("errorBorder")||e.parent().after('<div class="errorText totalError total2Error"><br/>Total Must be an integer between 0-999.</div>'),e.addClass("errorBorder")}function removeTotal2Error(e){e.parent().parent().find(".total2Error").remove(),e.removeClass("errorBorder")}function addMissingQuestionError(e){e.hasClass("errorBorder")||e.find(".drFooter").append('<div class="errorText missingQuestionError"><br/>Add a Question to the Discovery Rule.</div>'),e.addClass("errorBorder")}function removeMissingQuestionError(e){e.find(".missingQuestionError").remove(),e.removeClass("errorBorder")}function saveAllDiscoveryRules(e){function o(){this.Id=null,this.Name=null,this.Form_Template__c=$("#formTemplateName").data("sfid"),this.Threshold_1__c=null,this.Threshold_2__c=null,this.Discovery_Type__c=null,this.Operator_1__c=null,this.Operator_2__c=null,this.For_Discovery_Rule_Group__c=null}var r=[];$(".discoveryRuleList > li").each(function(){var e=new o;e.Id=$(this).data("sfid"),e.Name=$(this).find(".discoveryRuleNameInput").val().trim(),e.Threshold_1__c=$(this).find(".threshold1Input").val().trim(),e.Threshold_2__c=$(this).find(".threshold2Input").val().trim(),e.Discovery_Type__c=$(this).find(".discoveryTypeInput").data("sfid"),e.Operator_1__c=$(this).find(".operator1Input").val(),e.Operator_2__c=$(this).find(".operator2Input").val(),e.For_Discovery_Rule_Group__c=$(this).find(".forDRG").is(":checked"),e.Discovery_Field_For_Form__c=$(this).find(".formLookup:visible").length?$(this).find(".formLookup").val():null,e.Discovery_Field_For_Form__c=e.Discovery_Field_For_Form__c===nullSelect?null:e.Discovery_Field_For_Form__c,e.Discovery_Field_For_Discovery__c=$(this).find(".discoLookup:visible").length?$(this).find(".discoLookup").val():null,e.Discovery_Field_For_Discovery__c=e.Discovery_Field_For_Discovery__c===nullSelect?null:e.Discovery_Field_For_Discovery__c,console.log(e),r.push(e)}),Visualforce.remoting.Manager.invokeAction(upsertDRs,r,templateID,function(o,r){"exception"==r.type?(alert("There was an error updating your discovery rules..\n"+JSON.stringify(o)),hideModal(savingModal,fade),console.log("error result:"+o)):($(".discoveryRuleList > li").each(function(e){$(this).data("sfid",o[e].Id)}),"function"==typeof e&&e())})}function saveAllDRVs(){function e(){this.Question_Value__c=null,this.Discovery_Rule__c=null,this.Weighted_Value__c=null}var o=[];$(".selectedQuestions > li").each(function(){var r=$(this).data("picklistvalues"),t=$(this).closest(".discoveryRuleBox").data("sfid");$.each(r,function(){var r=new e;r.Question_Value__c=this.qvid,r.Discovery_Rule__c=t,r.Weighted_Value__c=this.weight,console.log(r),o.push(r)})}),Visualforce.remoting.Manager.invokeAction(insertDRVs,o,templateID,function(e,o){"exception"==o.type?(alert("There was an error updating your discovery rule values. please re-try."),hideModal(savingModal,fade),console.log("error result:"+e)):nextPage()})}function selectingDiscoveryType(e){showModal(discoveryTypeModal,fade),console.log(e),discoveryTypeSelecting=e,discoveryTypeSelecting.data("sfid",e.data("sfid"))}function adjustSecondOperator(e){var o=e.val();"Equal To"==o?(e.siblings(".andClause").find(".operator2Input").val("--None--"),e.siblings(".andClause").find(".threshold2Input").val(""),e.siblings(".andClause").hide()):e.siblings(".andClause").show()}function editQuestionValues(e){$questionEditing=e;var o=e.data("picklistvalues"),r=qvModal.find(".modalTable");null!==o&&$.each(o,function(){this.weight=this.weight||"0",r.append('<tr><td class="valueName" data-qvid="'+this.qvid+'">'+this.name+'</td><td><input type="text" value="'+this.weight+'" class="weightValue"/></td></tr>')}),showModal(qvModal,fade)}function updateQuestionValues(){var e=[];$(".weightValue").each(function(){var o={};o.qvid=$(this).parent().parent().find(".valueName").data("qvid"),o.name=$(this).parent().parent().find(".valueName").text(),o.weight=$(this).val(),e.push(o)}),$questionEditing.data("picklistvalues",e),hideModal(qvModal,fade),resetModals()}function removeQuestion(e){confirm("Are you sure you want to remove this Question?")&&(e.fadeOut(),setTimeout(function(){e.remove()},500))}function removeDiscoveryRule(e){confirm("Are you sure you want to remove this Discovery Rule?")&&(e.fadeOut(),setTimeout(function(){e.remove()},500))}function resetModals(){resetQvModal()}function resetQvModal(){qvModal.find("tr:not(:first)").remove()}function showModal(e,o){e.fadeIn(),o.fadeIn()}function hideModal(e,o,r){e.fadeOut(),null!==o&&void 0!==o&&o.fadeOut(),"function"==typeof r&&r()}function makeDiscoveryRulesDroppable(){$(".selectedQuestions").droppable({accept:".draggableNewQuestion",drop:function(e,o){var r=o.draggable.text(),t=$(this).parent().find("li"),i=!1;if(t.each(function(){var e=$.trim($(this).text().trim().split("Edit")[0]);e==r.trim()&&(i=!0,alert("Each question can only be used once per discovery rule."))}),i===!1){$(this).find(".placeholderText").remove(),$(this).append(newQuestionHTML);var s=$(this).find("li").last();s.find(".questionLabel").text(o.draggable.text().trim()),s.data("picklistvalues",o.draggable.data("picklistvalues")),editQuestionValues(s)}}})}function updateTitle(e){$(e).attr("title")!=$(e).val()&&$(e).attr("title",$(e).val())}function nextPage(){window.top.location="/apex/TB_DiscoveryRuleGroups?templateId="+templateID}function clearThresholdIfEmpty(e){console.log(e.val()),""===e.val().trim()&&e.next().val("")}function toggleDiscoveryType(e){var o=e.closest(".sectionBox");o.find(".discoveryTypeEntry").toggle().find(".discoveryTypeInput").val("").data("sfid",null),o.find(".lookups").toggle()}var discoveryTypeModal,fade,qvModal,savingModal,errorModal,$questionEditing;$(document).ready(function(){var e=namespace;discoveryTypeModal=$("#discoveryTypeModal"),fade=$("#fade"),savingModal=$("#savingStatus"),qvModal=$("#qvModal"),errorModal=$("#errorModal"),$(document).tooltip({position:{my:"center bottom",at:"center top"}}),$(".draggableNewQuestion").draggable({cursor:"move",helper:"clone",revert:"invalid",appendTo:"body",start:function(e,o){o.helper.addClass("draggingQuestion")}}),makeDiscoveryRulesDroppable(),discoveryTypeAutoComplete(),$("#newDRButton").on("click",function(){var e='<li class="sectionBox discoveryRuleBox"><div class="bannerHeader"><input type="text" class="discoveryRuleNameInput" value="New Discovery Rule"/><div class="DRGcheckbox">For Discovery Rule Group? <input class="forDRG" type="checkbox" onClick="toggleDiscoveryType($(this))"/></div><div class="cloneBtn" onClick="cloneDR($(this).closest(\'.discoveryRuleBox\'));">Clone</div><div class="closeButton" onClick="removeDiscoveryRule($(this).closest(\'.discoveryRuleBox\'));"><i class="fa fa-remove"></i></div></div>	<ul class="selectedQuestions"><div class="placeholderText">DRAG QUESTIONS HERE</div></ul><div class="drFooter"><span class="discoveryTypeEntry">DiscoveryType <input placeholder="Start typing discovery type name.." type="text" class="discoveryTypeInput" onchange="updateTitle(this)" autocomplete="off"/></span> IF <select  value="Greater Than" class="operatorInput operator1Input"  onChange="adjustSecondOperator($(this));"><option value="Greater Than" selected>Greater Than</option><option value="Less Than">Less Than</option><option value="Equal To">Equal To</option></select> <input type="number" value="0" class="thresholdInput threshold1Input"/> <span class="andClause"> AND <select  value="Greater Than" class="operatorInput operator2Input" onChange="clearThresholdIfEmpty($(this));"><option value="">--None--</option><option value="Greater Than">Greater Than</option><option value="Less Than">Less Than</option></select><input type="number" value="" class="thresholdInput threshold2Input"/></span><div class="lookups"><p>Relate to this form\'s</p><select class="formLookup"><option selected="selected" value="">Select A Lookup Field</option></select><p class="after-form-picklist">by filling in the</p><select class="discoLookup"><option selected="selected" value="">Select A Lookup Field</option></select><a href="#" data-title="This lookup is empty. Add a field on the Discovery object that looks up to the object identified in the Form Field lookup." class="tooltip disco-tooltip"><i class="fa fa-question-circle icon-disco-tooltip icon-disco-tooltip-dark"></i></a><p class="after-picklist">discovery field</p></div><div></li>';$(".discoveryRuleList").append(e);var o=$(".discoveryRuleList .sectionBox:last-child");o.find(".formLookup").change(function(){var e=this;populateDiscoPicklists(e)}),populateFormPicklists(o),makeDiscoveryRulesDroppable(),discoveryTypeAutoComplete()}),$(".closeButton").click(function(e){hideModal(discoveryTypeModal,fade),hideModal(qvModal,fade),resetModals(),e.preventDefault()}),$("#back").click(function(e){window.top.location="/apex/TB_SimpleDiscoveryRules?templateId="+templateID,e.preventDefault()}),$(".selectDiscoveryType").click(function(e){discoveryTypeSelecting.val($(this).parent().parent().find(".discoveryTypeName").html()),discoveryTypeSelecting.data("sfid",$(this).data("sfid")),hideModal(discoveryTypeModal,fade),e.preventDefault()}),$('.operator1Input option[value=""]').remove(),populateFormPicklists(),$(".formLookup").change(function(){var e=this;populateDiscoPicklists(e)}),existingDiscoveryRulesJSON.forEach(function(o){var r,t;o.hasOwnProperty(e+"Discovery_Field_For_Form__c")&&null!==o[e+"Discovery_Field_For_Form__c"]&&o.hasOwnProperty(e+"Discovery_Field_For_Discovery__c")&&null!==o[e+"Discovery_Field_For_Discovery__c"]&&(r=$("[data-sfid="+o.Id+"]"),t=r.find(".formLookup"),t.val(o[e+"Discovery_Field_For_Form__c"]),t.trigger("change"),r.find(".discoLookup").val(o[e+"Discovery_Field_For_Discovery__c"]))}),$(".operator1Input").each(function(){adjustSecondOperator($(this))})});var newQuestionHTML='<li class="questionBox notDraggable"><span class="questionLabel"></span><a class="editLink" onClick="editQuestionValues($(this).parent());">Edit</a><div class="closeButton" onClick="removeQuestion($(this).parent());"><i class="fa fa-remove"></i></div></li>';