"use strict";function discoveryTypeAutoComplete(){$(".discoveryTypeInput").autocomplete({source:discoveryTypeOptions,select:function(e,o){e.preventDefault(),$(this).val(o.item.label),$(this).data("sfid",o.item.value)}})}function populateFormPicklists(e){var o;o=e?e.find(".formLookup"):$(".formLookup");var r=Object.keys(formFields2DiscoveryFields);r.forEach(function(e){var r='<option value="'+e+'">'+e+"</option>";o.append(r)})}function populateDiscoPicklists(e){var o=$(e).val(),r=formFields2DiscoveryFields[o],i=$(e).closest(".lookups"),t=i.find(".discoLookup");void 0===r?(t.find(".discoOption").remove(),i.find(".disco-tooltip").hide(),i.find("p.after-picklist").removeClass("after-picklist-moved")):r.length?(t.find(".discoOption").remove(),r.forEach(function(e){var o="<option class='discoOption' value=\""+e+'">'+e+"</option>";t.append(o)}),i.find(".disco-tooltip").hide(),i.find("p.after-picklist").removeClass("after-picklist-moved")):(t.find(".discoOption").remove(),i.find(".disco-tooltip").show(),i.find("p.after-picklist").addClass("after-picklist-moved"))}function makeDiscoveryRuleGroupsDroppable(){$(".selectedDiscoveryRule").droppable({accept:".draggableDiscoveryRule",drop:function(e,o){var r=o.draggable.text(),i=$(this).parent().find("li"),t=!1;if(i.each(function(){var e=$.trim($(this).text().trim().split("Edit")[0]);e==r.trim()&&(t=!0,alert("Each discovery rule can only be used once per discovery rule group."))}),t===!1){$(this).find(".placeholderText").remove(),$(this).append(newDiscoveryRuleHTML);var s=$(this).find("li").last();s.find(".questionLabel").text(o.draggable.text().trim()),s.data("sfid",o.draggable.data("sfid"))}}})}function cloneDRG(e){var o=e.clone();o.data("sfid",null),e.after(o),makeDiscoveryRuleGroupsDroppable()}function saveUpdates(){$("#fade").fadeIn(),$("#savingStatus").fadeIn(),validateAndSave(function(){saveAllDiscoveryRuleGroups(saveDRGMs)})}function validateAndSave(e){var o=!1;$(".selectedDiscoveryRule").each(function(){$(this).find("li").length<2?(o=!0,addDiscoveryRuleTotalError($(this)),hideModal(savingModal),showModal(errorModal,fade)):removDiscoveryRuleTotalError($(this))}),$(".discoveryTypeInput").each(function(){0==$(this).val().trim().length?(addDiscoveryTypeError($(this)),o=!0):removeDiscoveryTypeError($(this))}),$(".discoLookup:visible").each(function(){var e=$(this).val();if(e===nullSelect||null===e||""===e){var r=$(this).parent().find(".formLookup").val();r===nullSelect||null===r||""===r?removeDiscoLookupError($(this)):(addDiscoLookupError($(this)),o=!0)}else removeDiscoLookupError($(this))}),o===!0?(hideModal(savingModal),showModal(errorModal,fade)):($(".errorText").remove(),$(".errorBorder").removeClass("errorBorder"),"function"==typeof e&&e())}function addDiscoveryRuleTotalError(e){0==e.parent().find(".discoveryRuleTotalError").length&&e.parent().append('<div class="errorText discoveryRuleTotalError"><br/>Each discovery rule group requires a minimum of 2 discovery rules')}function removDiscoveryRuleTotalError(e){e.parent().find(".discoveryRuleTotalError").remove(),e.removeClass("errorBorder")}function addDiscoveryTypeError(e){e.hasClass("errorBorder")||e.parent().parent().append('<div class="errorText discoveryTypeError"><br/>Discovery Type is required.</div>'),e.addClass("errorBorder")}function removeDiscoveryTypeError(e){e.parent().parent().find(".discoveryTypeError").remove(),e.removeClass("errorBorder")}function addDiscoLookupError(e){e.hasClass("errorBorder")||e.parent().after('<div class="errorText discoLookupError"><br/>Discovery Lookup must be filled in.</div>'),e.addClass("errorBorder")}function removeDiscoLookupError(e){e.parent().parent().find(".discoLookupError").remove(),e.removeClass("errorBorder")}function saveAllDiscoveryRuleGroups(e){function o(){this.Name=null,this.Form_Template__c=$("#formTemplateName").data("sfid"),this.Discovery_Type__c=null}var r=[];$(".discoveryRuleGroupList > li").each(function(){var e=new o;e.Name=$(this).find(".discoveryRuleGroupNameInput").val().trim(),e.Discovery_Type__c=$(this).find(".discoveryTypeInput").data("sfid"),e.Discovery_Field_For_Form__c=$(this).find(".formLookup").val(),e.Discovery_Field_For_Form__c=e.Discovery_Field_For_Form__c===nullSelect?null:e.Discovery_Field_For_Form__c,e.Discovery_Field_For_Discovery__c=$(this).find(".discoLookup").val(),e.Discovery_Field_For_Discovery__c=e.Discovery_Field_For_Discovery__c===nullSelect?null:e.Discovery_Field_For_Discovery__c,console.log(e),r.push(e)}),Visualforce.remoting.Manager.invokeAction(insertDiscoveryRuleGroups,r,templateID,function(o,r){"exception"==r.type?(alert("There was an error updating your discovery rule groups.\n"+JSON.stringify(o)),hideModal(savingModal,fade),console.log("error result:"+o)):($(".discoveryRuleGroupList > li").each(function(e){$(this).data("sfid",o[e].Id)}),"function"==typeof e&&e())})}function saveDRGMs(){function e(){this.Discovery_Rule__c=null,this.Discovery_Rule_Group__c=null}var o=[];$(".selectedDiscoveryRule > li").each(function(){var r=new e;r.Discovery_Rule__c=$(this).data("sfid"),r.Discovery_Rule_Group__c=$(this).closest(".discoveryRuleGroupBox").data("sfid"),console.log(r),o.push(r)}),Visualforce.remoting.Manager.invokeAction(insertDRGMs,o,templateID,function(e,o){"exception"==o.type?(alert("There was an error creating the discovery rule group members. please re-try."),hideModal(savingModal,fade),console.log("error result:"+e)):nextPage()})}function selectingDiscoveryType(e){showModal(discoveryTypeModal,fade),console.log(e),discoveryTypeSelecting=e,discoveryTypeSelecting.data("sfid",e.data("sfid"))}function removeDiscoveryRuleGroup(e){confirm("Are you sure you want to remove this Discovery Rule Group?")&&(e.fadeOut(),setTimeout(function(){e.remove()},500))}function removeDiscoveryRule(e){confirm("Are you sure you want to remove this Discovery Rule?")&&(e.fadeOut(),setTimeout(function(){e.remove()},500))}function updateTitle(e){$(e).attr("title")!=$(e).val()&&$(e).attr("title",$(e).val())}function showModal(e,o){e.fadeIn(),o.fadeIn()}function hideModal(e,o,r){e.fadeOut(),null!=o&&o.fadeOut(),"function"==typeof r&&r()}function nextPage(){window.top.location="/apex/TB_CustomizeFormTemplateProperties?templateId="+templateID}var discoveryTypeModal,fade,savingModal,errorModal;$(document).ready(function(){var e=namespace;discoveryTypeModal=$("#discoveryTypeModal"),fade=$("#fade"),savingModal=$("#savingStatus"),errorModal=$("#errorModal"),$(document).tooltip({position:{my:"center bottom",at:"center top"}}),$(".draggableDiscoveryRule").draggable({cursor:"move",helper:"clone",revert:"invalid",appendTo:"body",start:function(e,o){o.helper.addClass("draggingQuestion")}}),makeDiscoveryRuleGroupsDroppable(),discoveryTypeAutoComplete(),$("#newDRButton").on("click",function(){var e='<li class="sectionBox discoveryRuleGroupBox"><div class="bannerHeader"><input type="text" class="discoveryRuleGroupNameInput" value="New Discovery Rule Group"/><div class="cloneBtn" onClick="cloneDRG($(this).closest(`.discoveryRuleGroupBox`));">Clone</div><div class="closeButton" onClick="removeDiscoveryRuleGroup($(this).closest(\'.discoveryRuleGroupBox\'));"><i class="fa fa-remove"></i></div></div>	<ul class="selectedQuestions selectedDiscoveryRule"><div class="placeholderText">DRAG DISCOVERY RULES HERE</div></ul><div class="drFooter"><span class="discoveryTypeEntry">Discovery Type <input placeholder="Start typing discovery type name.." type="text" class="discoveryTypeInput"  onchange="updateTitle(this)" autocomplete="off"/></span><div class="lookups"><p>Relate to this form\'s</p><select class="formLookup"><option selected="selected" value="">Select A Lookup Field</option></select><p class="after-form-picklist">by filling in the</p><select class="discoLookup"><option selected="selected" value="">Select A Lookup Field</option></select><a href="#" data-title="This lookup is empty. Add a field on the Discovery object that looks up to the object identified in the Form Field lookup." class="tooltip disco-tooltip"><i class="fa fa-question-circle icon-disco-tooltip icon-disco-tooltip-dark"></i></a><p class="after-picklist">discovery field</p></div><div></li>';$(".discoveryRuleGroupList").append(e);var o=$(".discoveryRuleGroupList .sectionBox:last-child");o.find(".formLookup").change(function(){var e=this;populateDiscoPicklists(e)}),populateFormPicklists(o),makeDiscoveryRuleGroupsDroppable(),discoveryTypeAutoComplete()}),$("#back").click(function(e){window.top.location="/apex/TB_DiscoveryRules?templateId="+templateID,e.preventDefault()}),$(".selectDiscoveryType").click(function(e){discoveryTypeSelecting.val($(this).parent().parent().find(".discoveryTypeName").html()),discoveryTypeSelecting.data("sfid",$(this).data("sfid")),hideModal(discoveryTypeModal,fade),e.preventDefault()}),$(".closeButton").click(function(e){hideModal(discoveryTypeModal,fade),e.preventDefault()}),populateFormPicklists(),$(".formLookup").change(function(){var e=this;populateDiscoPicklists(e)}),existingDiscoveryRuleGroupsJSON.forEach(function(o){var r,i;o.hasOwnProperty(e+"Discovery_Field_For_Form__c")&&o[e+"Discovery_Field_For_Form__c"]!==nullSelect&&o.hasOwnProperty(e+"Discovery_Field_For_Discovery__c")&&o[e+"Discovery_Field_For_Discovery__c"]!==nullSelect&&(r=$("[data-sfid="+o.Id+"]"),i=r.find(".formLookup"),i.val(o[e+"Discovery_Field_For_Form__c"]),i.trigger("change"),r.find(".discoLookup").val(o[e+"Discovery_Field_For_Discovery__c"]))})});var newDiscoveryRuleHTML='<li class="questionBox notDraggable"><span class="questionLabel"></span><div class="closeButton" onClick="removeDiscoveryRule($(this).parent());"><i class="fa fa-remove"></i></div></li>';